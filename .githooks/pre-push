#!/bin/bash
#
# Pre-push hook to run tests before pushing to GitHub
# This ensures code works correctly before sharing with others
#

set -e

# Acquire lock to prevent concurrent pre-push hooks
# This ensures only one push runs tests at a time
LOCK_FILE="/tmp/lumina-pre-push.lock"
LOCK_FD=200

# Cleanup lock on exit
cleanup() {
    flock -u $LOCK_FD 2>/dev/null || true
    rm -f "$LOCK_FILE" 2>/dev/null || true
}
trap cleanup EXIT

# Try to acquire lock (wait if another push is running)
exec {LOCK_FD}>"$LOCK_FILE"
if ! flock -n $LOCK_FD; then
    echo "â³ Another git push is running tests, waiting..."
    if ! flock -w 600 $LOCK_FD; then
        echo "âŒ Could not acquire lock after 10 minutes. Another push may be stuck."
        echo "   Run: rm -f $LOCK_FILE"
        exit 1
    fi
fi

echo "ðŸ§ª Running pre-push tests..."
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo -e "${RED}âœ— Not in a git repository${NC}"
    exit 1
fi

# Check if virtual environment is activated
if [ -z "$VIRTUAL_ENV" ]; then
    echo -e "${YELLOW}âš  Virtual environment not activated${NC}"
    echo "  Attempting to activate venv..."
    if [ -d "venv" ]; then
        source venv/bin/activate
    else
        echo -e "${RED}âœ— No venv found. Run: python -m venv venv && source venv/bin/activate && pip install -e '.[dev]'${NC}"
        exit 1
    fi
fi

# 1. Run tests
echo -e "${YELLOW}1. Running test suite...${NC}"
PYTEST_BIN="${VIRTUAL_ENV:-venv}/bin/pytest"
if [ ! -f "$PYTEST_BIN" ]; then
    PYTEST_BIN="venv/bin/pytest"
fi

# Run tests with pytest-xdist for parallel execution
# -n 4: Use 4 parallel workers
# -m "not integration": Skip integration tests (faster)
# --tb=short: Shorter traceback format
# -q: Quiet mode
if "$PYTEST_BIN" -n 4 -m "not integration" --tb=short -q 2>&1; then
    echo -e "${GREEN}  âœ“ All tests passed${NC}"
else
    echo -e "${RED}  âœ— Tests failed${NC}"
    echo ""
    echo "  Fix the failing tests before pushing"
    echo "  Run: pytest -v  # for verbose output"
    exit 1
fi

# 2. Build Docker images (only if Docker-related files changed)
echo ""
echo -e "${YELLOW}2. Checking Docker build...${NC}"

# Check if any Docker-related files changed in this push
DOCKER_FILES_CHANGED=$(git diff --name-only HEAD~1..HEAD 2>/dev/null | grep -E "(Dockerfile|docker-compose|pyproject.toml|requirements)" || true)

if [ -n "$DOCKER_FILES_CHANGED" ]; then
    echo "  Docker-related files changed, rebuilding..."
    if docker compose build 2>&1 | tail -20; then
        echo -e "${GREEN}  âœ“ Docker images built successfully${NC}"
    else
        echo -e "${RED}  âœ— Docker image build failed${NC}"
        echo ""
        echo "  Run: docker compose build"
        echo "  Fix any build issues before pushing"
        exit 1
    fi
else
    echo -e "${GREEN}  âœ“ No Docker-related changes, skipping build${NC}"
fi

# All checks passed!
echo ""
echo -e "${GREEN}âœ“ All pre-push checks passed!${NC}"
echo -e "${GREEN}  Pushing to GitHub...${NC}"
echo ""

exit 0
